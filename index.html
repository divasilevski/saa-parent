<!DOCTYPE html>
<html>
  <body>
    <button id="btn">permissions</button>
    <iframe
      src="https://saa-iframe.vercel.app/"
      sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin"
    ></iframe>
    <script>
      window.addEventListener("message", (event) => {
        console.log("message", event.data);
      });

      const $btn = document.querySelector("#btn");

      $btn.onclick = () => {
        navigator.permissions
          .query({
            name: "top-level-storage-access",
            requestedOrigin: "https://saa-iframe.vercel.app/",
          })
          .then((res) => {
            if (res.state === "granted") {
              // Permission has already been granted
              // You can request storage access without any user gesture
              rSAFor();
            } else if (res.state === "prompt") {
              // Requesting storage access requires user gesture
              // For example, clicking a button
              const btn = document.createElement("button");
              btn.textContent = "Grant access";
              btn.addEventListener("click", () => {
                // Request storage access
                rSAFor();
              });
              document.body.appendChild(btn);
            }
          });

        function rSAFor() {
          if ("requestStorageAccessFor" in document) {
            document
              .requestStorageAccessFor("https://saa-iframe.vercel.app/")
              .then(
                (res) => {
                  console.log(document.cookie);
                },
                (err) => {
                  console.log(err);
                }
              );
          }
        }
      };
    </script>
  </body>
</html>
